name: example integration tests

on:
  push:
    branches:
      - main
      - '*.x'
  pull_request:

permissions:
  contents: read

jobs:
  example-smoke-test:
    timeout-minutes: 5
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install root dependencies
        run: bun install

      - name: Build revurb
        run: bun run build

      - name: Install example dependencies
        run: cd example && bun install

      - name: Start example app in background
        run: |
          cd example
          timeout 30s bun run dev > ../example-output.log 2>&1 &
          echo $! > ../example-pid.txt
          sleep 5

      - name: Check WebSocket server is running
        run: |
          curl -f http://127.0.0.1:8080/up || (cat example-output.log && exit 1)

      - name: Check frontend server is running
        run: |
          curl -f http://localhost:3000 || (cat example-output.log && exit 1)

      - name: Test WebSocket connection
        run: |
          bun -e "
          import { WebSocket } from 'ws';
          const ws = new WebSocket('ws://127.0.0.1:8080/app/my-app-key?protocol=7&client=js&version=8.4.0');
          ws.on('open', () => {
            console.log('✅ WebSocket connection successful');
            ws.close();
            process.exit(0);
          });
          ws.on('error', (err) => {
            console.error('❌ WebSocket connection failed:', err);
            process.exit(1);
          });
          setTimeout(() => {
            console.error('❌ WebSocket connection timeout');
            process.exit(1);
          }, 10000);
          " || (cat example-output.log && exit 1)

      - name: Stop example app
        if: always()
        run: |
          if [ -f example-pid.txt ]; then
            kill $(cat example-pid.txt) || true
          fi

      - name: Upload example logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: example-logs
          path: example-output.log
