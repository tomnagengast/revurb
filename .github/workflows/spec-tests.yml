name: spec tests

on:
  push:
    branches:
      - main
      - '*.x'
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: true
      matrix:
        bun: ['1.3.2', 'latest']

    name: Bun ${{ matrix.bun }} - Spec Tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ matrix.bun }}

      - name: Install dependencies
        run: bun install

      - name: Pull Autobahn Docker image
        run: docker pull crossbario/autobahn-testsuite

      - name: Start WebSocket server
        run: bun run src/cli.ts start --host=127.0.0.1 --port=8080 &
        env:
          REVERB_APP_ID: test-app-id
          REVERB_APP_KEY: test-app-key
          REVERB_APP_SECRET: test-app-secret

      - name: Wait for server to be ready
        run: |
          timeout=30
          while ! curl -f http://127.0.0.1:8080/up > /dev/null 2>&1; do
            sleep 1
            timeout=$((timeout-1))
            if [ $timeout -eq 0 ]; then
              echo "Server failed to start"
              exit 1
            fi
          done

      - name: Run specification tests
        working-directory: reverb/tests/Specification
        run: |
          docker run --rm \
            -v $PWD:/mnt/autobahn \
            -v $PWD/reports:/mnt/autobahn/reports \
            --add-host host.docker.internal:host-gateway \
            crossbario/autobahn-testsuite \
            wstest -m fuzzingclient -s /mnt/autobahn/client-spec.json
