last commit: 5c5deaf82ec22d76f0b8236cf353bd6853accbf7
status: not ok
review comments:
- HTTP API responses always come back as 200 text/plain because `Factory.convertToResponse` reads the nonexistent fields `status`/`content` instead of the custom response getters. The custom HTTP response stores its status in `statusCode` (`revurb-ts/src/Servers/Reverb/Http/response.ts:42-101`), but `convertToResponse` hard-codes `controllerResponse.status || 200` and derives the content type purely from whether the body is a string (`revurb-ts/src/Servers/Reverb/factory.ts:1085-1099`). As a result ChannelController/EventsController can never surface 401/422 errors like the PHP version (`src/Protocols/Pusher/Http/Controllers/Controller.php:37-82`)—clients see 200 OK even when auth fails. Please read the actual status/headers when mapping to Bun’s `Response` to keep parity.
- The `/apps/{appId}/users/{userId}/terminate_connections` endpoint currently throws before doing anything: `Factory.initialize` wires `serverProvider = { pubSub: () => null }` (`revurb-ts/src/Servers/Reverb/factory.ts:238-266`), but `UsersTerminateController.handle` immediately calls `this.serverProvider.subscribesToEvents()` (`revurb-ts/src/Protocols/Pusher/Http/Controllers/users-terminate-controller.ts:63-85`). Because the stub lacks that method, Bun raises “subscribesToEvents is not a function” and the endpoint never publishes nor disconnects users, unlike the PHP implementation which uses `ServerProviderManager::subscribesToEvents()` (`src/Protocols/Pusher/Http/Controllers/UsersTerminateController.php:16-33`). You either need a real ServerProvider implementation or to guard the call when no pub/sub is configured.
- `ChannelConnection` no longer proxies methods to the underlying connection, but jobs still treat it exactly like the PHP object. `PruneStaleConnections.handle` iterates `channelManager.connections()` and calls `connection.isStale()`, `connection.disconnect()`, and `connection.id()` (`revurb-ts/src/jobs/prune-stale-connections.ts:63-93`). Our `ChannelConnection` class only exposes `connection()`, `data()` and `send()` (`revurb-ts/src/Protocols/Pusher/Channels/channel-connection.ts:43-121`), so the first call to `isStale()` throws “isStale is not a function” and no stale sockets are ever pruned. The original PHP wrapper forwards unknown method calls to the base connection (`src/Protocols/Pusher/Channels/ChannelConnection.php:29-44`). We need to expose those proxy methods or fetch the raw connection before invoking them.
- Even once the server-provider issue is fixed, `UsersTerminateController`’s responses are malformed because it calls the custom `Response` constructor with the options object as the second argument (`revurb-ts/src/Protocols/Pusher/Http/Controllers/users-terminate-controller.ts:80-104`). The constructor signature is `(data, statusCode = 200, headers = {}, json = false)` (`revurb-ts/src/Servers/Reverb/Http/response.ts:30-55`), so passing `{ status: 200, headers: { ... } }` turns `statusCode` into an object and drops the headers. PHP returns `new Response((object) [])` with a real status code (`src/Protocols/Pusher/Http/Controllers/UsersTerminateController.php:33-40`). Use the correct positional arguments (e.g. `new Response({}, 200, { 'Content-Type': 'application/json' })`) so clients get valid JSON.
