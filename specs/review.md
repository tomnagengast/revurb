last commit: 651187edf614e11792e88e60d661d718e93469d1
status: not ok
review comments:
- `revurb-ts/src/jobs/ping-inactive-connections.ts:63-74` treats each entry from `ChannelManager.connections()` as if it were a `Connection`, calling `.isActive()` on a `ChannelConnection` instance that doesn’t implement that method. As soon as the job runs it throws `TypeError: connection.isActive is not a function`, so inactive sockets are never pinged. Unwrap the underlying connection (`channelConnection.connection()`) before checking activity and pinging.
- Presence membership never sees any subscribers because `_connections.all()` returns a `Map`, yet `PresenceChannel`/`PresenceCacheChannel` call `Object.values` on it (`revurb-ts/src/Protocols/Pusher/Channels/presence-channel.ts:165-234`, `.../presence-cache-channel.ts:132-219`). `Object.values(new Map())` yields `[]`, so `userIsSubscribed` always returns false, `member_added` emits on every subscribe, `member_removed` never fires, and `presence` counts/hashes are always empty. Convert the map to an array via `Array.from(this._connections.all().values())` (or have `all()` return an array) before iterating.
- Metrics HTTP endpoints can’t return data because `revurb-ts/src/Protocols/Pusher/metrics-handler.ts:224-263` assumes `channelManager.for(app).all()` returns an array and that `channel.connections()` exposes `.length`/is iterable. In reality `ChannelManager.all()` returns a plain object (`revurb-ts/src/Protocols/Pusher/Managers/array-channel-manager.ts:129-136`) and `Channel.connections()` returns a record (`revurb-ts/src/Protocols/Pusher/Channels/channel.ts:121-141`). As a result `channel.connections().length` is `undefined` (so every channel is filtered out) and `for (const connection of channel.connections())` throws because objects aren’t iterable. Update the manager to return arrays or adjust the metrics logic to use `Object.values` before filtering/looping.
